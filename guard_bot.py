# bot.py - Guard Bot Lengkap untuk Termux (Optimasi RAM)import asyncioimport timeimport jsonfrom collections import defaultdictfrom datetime import datetimeimport osfrom telethon import TelegramClient, eventsfrom telethon.tl.types import MessageEntityMentionNameimport config# ===== INIT BOT =====print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")print("â•‘   GUARD BOT - TERMUX ED    â•‘")print("â•‘   Fitur Lengkap + Ringan   â•‘")print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")# Inisialisasi client dengan optimasibot = TelegramClient('guard_session', config.API_ID, config.API_HASH,                     connection_retries=5,                     retry_delay=1,                     flood_sleep_threshold=60)bot.start(bot_token=config.BOT_TOKEN)# ===== DATABASE (Pake dictionary biasa biar ringan) =====warnings = defaultdict(int)muted_users = {}spam_tracker = defaultdict(list)user_data = {}  # Nyimpen data usergroup_settings = {}  # Setting per grup (kalo multi grup)# ===== HELPER FUNCTIONS =====async def is_admin(user_id):    return user_id in config.ADMIN_IDSasync def delete_after(msg, seconds):    await asyncio.sleep(seconds)    try:        await msg.delete()    except:        passasync def log_to_admin(text):    """Kirim log ke admin"""    for admin_id in config.ADMIN_IDS:        try:            await bot.send_message(admin_id, f"ğŸ“ {text}")        except:            pass# ===== CEK SPAM =====def check_spam(user_id):    if not config.ANTI_SPAM["enabled"]:        return False        now = time.time()    # Bersihin data lama    spam_tracker[user_id] = [t for t in spam_tracker[user_id]                               if now - t < config.ANTI_SPAM["time_frame"]]    spam_tracker[user_id].append(now)        return len(spam_tracker[user_id]) > config.ANTI_SPAM["max_msg"]# ===== CEK LINK =====def has_link(text):    if not config.ANTI_LINK["enabled"]:        return False        if not text:        return False        text = text.lower()    if "http://" in text or "https://" in text or "t.me/" in text:        # Cek allowed domains        for allowed in config.ANTI_LINK["allowed_domains"]:            if allowed in text:                return False        return True    return False# ===== CEK KATA KASAR =====def has_toxic(text):    if not config.ANTI_TOXIC["enabled"] or not text:        return False        text = text.lower()    for kata in config.ANTI_TOXIC["words"]:        if kata in text:            return True    return False# ===== EVENT HANDLER UTAMA =====@bot.on(events.NewMessage)async def message_handler(event):    if not event.is_group:        return        user_id = event.sender_id    text = event.message.text or ""        # Skip kalo bot sendiri    if user_id == (await bot.get_me()).id:        return        # CEK MUTE    if user_id in muted_users:        if time.time() < muted_users[user_id]:            await event.delete()            return        else:            del muted_users[user_id]        # CEK SPAM (skip admin)    if not await is_admin(user_id):        if check_spam(user_id):            await event.delete()            action = config.ANTI_SPAM["action"]            if action == "mute":                muted_users[user_id] = time.time() + config.ANTI_SPAM["mute_duration"]                await event.reply(f"@{event.sender.username} Mute {config.ANTI_SPAM['mute_duration']//60} menit (spam)!")                await log_to_admin(f"Spam: @{event.sender.username} di-mute")            return                # CEK LINK        if has_link(text):            await event.delete()            action = config.ANTI_LINK["action"]            if action == "warn":                warnings[user_id] += 1                await event.reply(f"@{event.sender.username} Dilarang link! ({warnings[user_id]}/{config.ANTI_TOXIC['max_warn']})")            elif action == "mute":                muted_users[user_id] = time.time() + 300                await event.reply(f"@{event.sender.username} Mute 5 menit (link!)")            return                # CEK KATA KASAR        if has_toxic(text):            await event.delete()            warnings[user_id] += 1                        if warnings[user_id] >= config.ANTI_TOXIC["max_warn"]:                muted_users[user_id] = time.time() + 300                await event.reply(f"@{event.sender.username} Mute 5 menit (3x warning)!")                warnings[user_id] = 0            else:                msg = await event.reply(f"@{event.sender.username} Jangan toxic! ({warnings[user_id]}/{config.ANTI_TOXIC['max_warn']})")                asyncio.create_task(delete_after(msg, 5))            return        # AUTO RESPONSE    if text and config.AUTO_RESPONSE:        for trigger, response in config.AUTO_RESPONSE.items():            if trigger in text.lower():                await event.reply(response)                break        # HANDLE COMMANDS    if event.message.text and event.message.text.startswith('/'):        await command_handler(event)# ===== WELCOME HANDLER =====@bot.on(events.ChatAction)async def welcome_handler(event):    if event.user_joined or event.user_added:        if not config.WELCOME["enabled"]:            return                user = await event.get_user()        chat = await event.get_chat()                welcome_text = config.WELCOME["text"].format(            name=user.first_name,            user_id=user.id,            username=user.username or "None",            group_name=chat.title        )                msg = await bot.send_message(chat.id, welcome_text)        asyncio.create_task(delete_after(msg, 60))# ===== COMMAND HANDLER =====async def command_handler(event):    cmd = event.message.text.split()[0].lower()    user_id = event.sender_id    chat = event.chat    args = event.message.text.split()[1:] if len(event.message.text.split()) > 1 else []        # ===== PUBLIC COMMANDS =====    if cmd == '/start':        help_text = "**ğŸ¤– Guard Bot**\n\n**Commands:**\n"        for c in config.COMMANDS:            help_text += f"{c}\n"        await event.reply(help_text)        elif cmd == '/rules':        await event.reply(config.RULES_TEXT)        elif cmd == '/id':        if event.message.reply_to_msg_id:            reply = await event.message.get_reply_message()            await event.reply(f"ğŸ†” User: `{reply.sender_id}`")        else:            await event.reply(f"ğŸ†” ID kamu: `{user_id}`")        elif cmd == '/ping':        start = time.time()        msg = await event.reply("Pinging...")        end = time.time()        await msg.edit(f"Pong! ğŸ“ `{round((end-start)*1000)}ms`")        elif cmd == '/info':        if event.message.reply_to_msg_id:            reply = await event.message.get_reply_message()            user = await reply.get_sender()        else:            user = await event.get_sender()                info = f"""**Informasi User**ğŸ†” ID: `{user.id}`ğŸ‘¤ Nama: {user.first_name} {user.last_name or ''}ğŸ“› Username: @{user.username or 'None'}ğŸ¤– Bot: {'Ya' if user.bot else 'Tidak'}âš ï¸ Warnings: {warnings.get(user.id, 0)}ğŸ”‡ Muted: {'Ya' if user.id in muted_users else 'Tidak'}        """        await event.reply(info)        elif cmd == '/stats':        total_warns = sum(warnings.values())        total_muted = len(muted_users)        await event.reply(            f"ğŸ“Š **Statistik Grup**\n"            f"Total warnings: {total_warns}\n"            f"User muted: {total_muted}\n"            f"Anti Spam: {'ON' if config.ANTI_SPAM['enabled'] else 'OFF'}\n"            f"Anti Link: {'ON' if config.ANTI_LINK['enabled'] else 'OFF'}"        )        # ===== ADMIN COMMANDS =====    if not await is_admin(user_id):        return        if cmd == '/warn':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        target_id = reply.sender_id        warnings[target_id] += 1                if warnings[target_id] >= config.ANTI_TOXIC["max_warn"]:            muted_users[target_id] = time.time() + 300            await event.reply(f"User di-mute (3x warning)!")            warnings[target_id] = 0        else:            await event.reply(f"âš ï¸ Warning {warnings[target_id]}/{config.ANTI_TOXIC['max_warn']}")                await log_to_admin(f"Warning: {target_id} dari @{event.sender.username}")        elif cmd == '/mute':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        duration = int(args[0]) if args else 5        muted_users[reply.sender_id] = time.time() + (duration * 60)        await event.reply(f"ğŸ”‡ User mute {duration} menit")        await log_to_admin(f"Mute: {reply.sender_id} {duration} menit")        elif cmd == '/unmute':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        if reply.sender_id in muted_users:            del muted_users[reply.sender_id]            await event.reply("ğŸ”Š User unmute")        elif cmd == '/kick':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        await bot.kick_participant(chat.id, reply.sender_id)        await event.reply("ğŸ‘¢ User kicked")        await log_to_admin(f"Kick: {reply.sender_id}")        elif cmd == '/ban':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        await bot.edit_permissions(chat.id, reply.sender_id, view_messages=False)        await event.reply("â›” User banned")        await log_to_admin(f"Ban: {reply.sender_id}")        elif cmd == '/unban':        if not event.message.reply_to_msg_id:            await event.reply("Reply ke pesan user!")            return                reply = await event.message.get_reply_message()        await bot.edit_permissions(chat.id, reply.sender_id, view_messages=True)        await event.reply("âœ… User unbanned")        elif cmd == '/clean':        if not args:            await event.reply("Gunakan: /clean [jumlah]")            return                try:            count = int(args[0])            if count > 100:                count = 100                        msgs = await bot.get_messages(chat.id, limit=count)            await bot.delete_messages(chat.id, msgs)            await event.reply(f"ğŸ§¹ {count} pesan dihapus")        except:            await event.reply("Gagal hapus pesan")        elif cmd == '/settings':        settings = f"""**Pengaturan Bot**Anti Spam: {'ON' if config.ANTI_SPAM['enabled'] else 'OFF'}Anti Link: {'ON' if config.ANTI_LINK['enabled'] else 'OFF'}Anti Toxic: {'ON' if config.ANTI_TOXIC['enabled'] else 'OFF'}Welcome: {'ON' if config.WELCOME['enabled'] else 'OFF'}Admin: {config.ADMIN_IDS}        """        await event.reply(settings)        elif cmd == '/set':        if len(args) < 2:            await event.reply("Gunakan: /set [key] [value]")            return                key, value = args[0], args[1]                # Simple setting change (bisa dikembangin)        if key == "spam":            config.ANTI_SPAM["enabled"] = value.lower() == "on"            await event.reply(f"Anti Spam: {'ON' if config.ANTI_SPAM['enabled'] else 'OFF'}")        elif key == "link":            config.ANTI_LINK["enabled"] = value.lower() == "on"            await event.reply(f"Anti Link: {'ON' if config.ANTI_LINK['enabled'] else 'OFF'}")        else:            await event.reply("Setting tidak dikenal")# ===== SIMPAN DATA SECARA BERKALA (opsional) =====async def save_data():    """Backup data ke file biar gak hilang"""    while True:        await asyncio.sleep(300)  # Tiap 5 menit        data = {            "warnings": dict(warnings),            "muted_users": muted_users        }        with open("backup.json", "w") as f:            json.dump(data, f)        print("[âœ“] Data backed up")# ===== MAIN =====if __name__ == '__main__':    print("[âœ“] Bot running...")    print("[âœ“] Fitur: Anti Spam, Anti Link, Anti Toxic, Welcome, 20+ Commands")    print("[âœ“] Tekan Ctrl+C untuk stop")        # Load backup kalo ada    try:        with open("backup.json", "r") as f:            data = json.load(f)            warnings = defaultdict(int, data.get("warnings", {}))            muted_users = data.get("muted_users", {})        print("[âœ“] Data restored from backup")    except:        pass        # Jalankan backup di background    loop = asyncio.get_event_loop()    loop.create_task(save_data())        try:        bot.run_until_disconnected()    except KeyboardInterrupt:        print("\n[!] Stopped by user")        # Simpan data sebelum exit        with open("backup.json", "w") as f:            json.dump({                "warnings": dict(warnings),                "muted_users": muted_users            }, f)        print("[âœ“] Data saved")